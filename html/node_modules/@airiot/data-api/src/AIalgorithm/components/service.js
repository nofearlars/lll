import React from "react"
import { api, use } from 'xadmin'
import { Select } from 'antd'

const ServiceSelect = ({ input }) => {
  const [ops, setOps] = React.useState([])

  React.useEffect(() => {
    api({ name: 'algorithm/algorithmService/list' }).query({}, {}).then(({ items = [] }) => {
      setOps(items.map(item => ({ value: item.id, label: item.name })))
    })
  }, [])

  return <Select
    value={input.value}
    onChange={input.onChange}
    options={ops}
  />
}

const serviceFunc = ({ input }) => {
  const { form } = use('form')
  const [ops, setOps] = React.useState([])

  React.useEffect(() => {
    form.useField('algorithmID', ({ value }) => {
      if (value) {
        api({ name: `algorithm/algorithmService/${value}/schema` }).query({}, {}).then(({ items }) => {
          setOps(items)
        })
      }
    })
  }, [])

  const handleChange = (v) => {
    form.change('inputParams', ops.find(op => op.function === v)?.input)
    form.change('outputParams', ops.find(op => op.function === v)?.output)
    input.onChange(v)
  }

  return <Select
    value={input.value}
    onChange={handleChange}
    options={ops.map(item => ({ value: item.function, label: item.title }))}
  />
}

export { ServiceSelect, serviceFunc }
