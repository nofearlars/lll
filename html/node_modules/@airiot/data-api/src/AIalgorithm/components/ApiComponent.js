import React from 'react'
import { api, use } from 'xadmin'
import { TreeSelect } from 'antd'

const ApiComponent = ({ input }) => {
  const [list, setList] = React.useState([])
  const [loading, setLoading] = React.useState(false)
  const [apiList, setApiList] = React.useState([])
  const { form } = use('form')

  React.useEffect(() => {
    setLoading(true)
    api({ name: '/ds/group' }).query({}, {}).then(({ items = [] }) => {
      let apiList = []
      items.forEach(item => {
        apiList.push(api('Operation').query({}, { filter: { dataGroupId: item.id }}))
      })
      Promise.all(apiList).then(res => {
        let result = items.map(item => ({ id: item.id, value: item.id, title: item.name, disabled: true }))
        let apiL = []
        res?.forEach(re => {
          re?.items?.forEach(r => {
            apiL.push(r)
            result.push({
              id: r.id,
              pId: r.dataGroup?.id,
              value: r.key,
              title: r.name,
              isLeaf: true,
            })
          })
        })
        setApiList(apiL)
        setList(result)
        setLoading(false)
      })
    })
  }, [])

  const handleChange = (v) => {
    let api = apiList.find(a => a.key === v)
    form.change('inputParams', api)
    input.onChange(v)
  }

  return <TreeSelect
    loading={loading}
    treeDataSimpleMode
    style={{ width: '100%' }}
    value={input.value}
    dropdownStyle={{ maxHeight: 400, overflow: 'auto' }}
    onChange={handleChange}
    treeData={list}
  />
}

export default ApiComponent
