import { Layout, Menu, Card, Result, Space, Divider } from 'antd'
import React from 'react'
import { use, config as _c, Block, app, api } from 'xadmin'
import { Icon, Page } from 'xadmin-ui';

import Error from './Error'
import { IsAuthenticated, HasPermission } from 'xadmin-auth'
import MainMenu from '../components/MainMenu'
import SideMenu from '../components/SideMenu'

const { Sider } = Layout
import './layout.css'

const ErrorPage = ({ error, onClose }) => {
  const location = use('location')
  const [errorPath] = React.useState(location.pathname)

  React.useEffect(() => {
    if(errorPath != location.pathname) {
      onClose()
    }
  }, [ location ])

  return <Page title={_t1('系统错误')}><Error error={error} onClose={onClose} /></Page>
}

class AppError extends React.Component {

  state = {
    error: null
  }

  componentDidCatch(error, info) {
    this.setState({ error })
  }

  render() {
    const { error } = this.state
    let children = this.props.children
    if (error) {
      children = <ErrorPage error={error} onClose={() => this.setState({ error: null })} />
    }
    return children
  }

}

const App = props => {
  const [ collapsed, setCollapsed ] = React.useState(localStorage.getItem('Menu_collapsed') == 'false' ? false : true)
  const { settings } = use('settings')

  const onCollapse = (coll) => {
    setCollapsed(coll)
    localStorage.setItem('Menu_collapsed', coll)
  }

  return (
    <Layout style={{ minHeight: '100vh', overflow: 'auto' }} >
      <Sider
        className="antd-sider-left"
        collapsible
        collapsedWidth={60}
        collapsed={collapsed}
        onCollapse={onCollapse}
        style={!collapsed ? { minHeight: 300, height: 'calc(100vh)', overflow: 'auto' } : { minHeight: 300 }}>
        <div className="logo" style={{ appRegion: 'drag' }} onClick={() => app.go('/app/home')}>
          {/* <img src={settings?.logo || require('./../../icon/logo2.png')} alt="" /> */}
          {!collapsed && _c('site.title')}
        </div>
        <MainMenu name="mainmenu" theme="dark" mode="inline" />
        <SideMenu name="sidemenu" theme="dark" mode="inline" 
          style={{ position: 'absolute', bottom: 50, left: 0, right: 0 }}
        />
      </Sider>
      <div className="main-content" style={{ overflow: 'auto', width: '100%' }}>
        <AppError>{props.children}</AppError>
      </div>
    </Layout >
  )
}

const AuthApp = props => (
  <IsAuthenticated><App {...props } /></IsAuthenticated>
)

export default AuthApp
