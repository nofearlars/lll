import React from 'react';
import { ModelWrap } from 'xadmin-model';
import { app, use, api } from 'xadmin';
import { Button, Popconfirm, message } from 'antd';
import { HasPermission } from 'xadmin-auth';

import _ from 'lodash'
import { useRecoilState, useRecoilValue, useSetRecoilState } from 'recoil'
import { _t } from 'xadmin-i18n'

const WarningProcessedBtn = ({ item }) => {
  const { t:_t1, i18n } = useI18n()
  const setCount = use('warning.tabBadge')
  let getItems = () => null;
  let saveItem = () => null
  try {
    getItems = use('model.getItems')?.getItems
  } catch { }
  const { onProcessed } = use('warnings.confirm')

  const handleProcessed = () => {
    onProcessed(item).then(res => {
      getItems()
      if (res) {
        message.success('成功处理报警信息')
        item?.status == '已确认' && setCount && setCount()
      }
    })
  }

  if (!item) return ''
  if (item && 'handle' in item && item.handle == false) {
    return <HasPermission FailureComponent={null} permission="warning.edit"><Button size="small" disabled={true}>{_t1('无需处理')}</Button></HasPermission>
  } else {
    if (item.processed == undefined || item.processed == '未处理') {
      return (
        <HasPermission FailureComponent={null} permission="warning.edit">
          <Popconfirm title={_t1("是否处理报警？")} onConfirm={handleProcessed} okText={_t1("确认")} cancelText={_t1("取消")}>
            <Button size="small" type="primary" style={{ padding: '0 12.1px' }}>{_t1('处理')}</Button>
          </Popconfirm>
        </HasPermission>
      )
    }
  }
  return <HasPermission FailureComponent={null} permission="warning.edit"><Button size="small" disabled={true}>{item.processed}</Button></HasPermission >
}

export default WarningProcessedBtn 