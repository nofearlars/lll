
import React from 'react';
import app, { use, api } from 'xadmin';
import { SchemaForm } from 'xadmin-form'
import { C } from 'xadmin-ui';
import _ from 'lodash';
import { Card, Tag, Select, Checkbox, Tooltip, Typography, InputNumber, Form } from 'antd';
import { LogicEditor } from './LogicEditor'
const { Option, OptGroup } = Select

const getVarTag = (logic, arr) => {
  logic && _.isObject(logic) && Object.values(logic).forEach(item => {
    if (item?.length) {
      item.forEach(val => {
        if (_.isObject(val) && !val?.var) {
          getVarTag(val, arr)
        } else {
          val?.var?.length && arr.push(val.var[0])
        }
      })
    }
  })
  return arr
}

const FieldNameSelect = props => {
  const { input: { onChange, value }, field: { name: fieldName, schema = {}, type }, table } = props
  const [ tableMessage, setTableMessage ] = React.useState(null)
  let index = fieldName && fieldName.substring(fieldName.indexOf('[') + 1, fieldName.lastIndexOf(']'))
  const [fieldValue, setFieldValue] = React.useState([])

  let logic;
  if (schema?.logic) {
    try {
      logic = use('form', state => ({ logic: state.values.rules && _.get(state.values.rules[index], schema.logic) }))['logic']
    } catch (error) {
      console.log(error)
    }
  }

  React.useEffect(() => {
    if (logic) {
      logic = logic.type ? logic.logic : logic
      let varTag = getVarTag(logic, [])
      setFieldValue(varTag)
    }
  }, [logic])

  React.useEffect(() => {
    api({ name: `core/t/schema/${table}` }).fetch('', {}).then(({ json }) => {
      setTableMessage(json)
    })
  }, [ table ])

  return (
    <>
      {tableMessage?.id ?
        <C is="TagWrap" tableDataId={props?.nodeId} tableId={tableMessage.id}>
          {state => <LogicEditor {...props} {...state} table={tableMessage} fieldValue={fieldValue} />}
        </C>
        : null}
    </>
  )
}

export { FieldNameSelect, getVarTag }