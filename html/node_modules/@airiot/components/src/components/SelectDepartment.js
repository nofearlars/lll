import React from 'react'
import { api } from 'xadmin'
import { TreeSelect, Select, Spin, Empty } from 'antd'
import useInput from './hooks/useInput'
import useDropdown from './hooks/useDropdown'
import useInitOptions from './hooks/useInitOptions'

const mapper = (item) => {
  return {
    item: item,
    id: item.id,
    pId: item?.parent?.id,
    title: item.name,
    value: item.id
  }
}

const SelectDepartment = (props) => {
  const { input, multiple, onlyId } = props
  const [treeData, setTreeData] = useInitOptions(input?.value, mapper)
  const [list, setList] = React.useState([])

  const fetchDepartment = React.useCallback(async () => {
    const { items: _list } = await api({ name: 'core/department' }).query({ fields: ['parent'] }, {})
    const _treeData = _list.map(mapper)
    setList(_list)
    setTreeData(_treeData)
  }, [])

  const _input = useInput({ input, multiple, onlyId, list })

  const { onDropdownVisibleChange } = useDropdown({ fetch: fetchDepartment })

  return (
    <TreeSelect
      treeDataSimpleMode
      showSearch
      autoClearSearchValue
      treeNodeFilterProp='title'
      treeData={treeData}
      style={{ width: props.width || 150, minWidth: 120 }}
      {..._input}
      allowClear
      onDropdownVisibleChange={onDropdownVisibleChange}
      {...props}
      placeholder={_t1(props?.placeholder || props?.label)}
    ></TreeSelect>
  )
}

export default SelectDepartment
